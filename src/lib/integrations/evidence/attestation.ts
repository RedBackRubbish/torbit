/**
 * TORBIT - Attestation Generator
 * 
 * Generates human-readable, signed attestation statements.
 * "This build was exported on..."
 */

import type { AttestationFile, AttestationData } from './types'
import type { EnvironmentName } from '../environments/types'
import { createHash, createHmac } from 'node:crypto'

interface AttestationSigningOptions {
  signingSecret?: string
  signingKeyId?: string
}

// ============================================
// ATTESTATION GENERATOR
// ============================================

/**
 * Generate an attestation file for export
 */
export function generateAttestation(
  data: AttestationData,
  options: AttestationSigningOptions = {}
): AttestationFile {
  const statement = generateStatement(data)
  const hash = generateHash(JSON.stringify(data))
  const signature = options.signingSecret
    ? signHash(hash, options.signingSecret, options.signingKeyId || 'torbit-default')
    : undefined
  
  return {
    statement,
    data,
    generatedAt: new Date().toISOString(),
    hash,
    signature,
  }
}

/**
 * Generate human-readable attestation statement
 */
function generateStatement(data: AttestationData): string {
  const lines = [
    '═══════════════════════════════════════════════════════════════',
    '                    TORBIT EXPORT ATTESTATION                   ',
    '═══════════════════════════════════════════════════════════════',
    '',
    `This build was exported on ${formatDate(data.exportDate)}.`,
    '',
    '┌─────────────────────────────────────────────────────────────┐',
    '│ ENVIRONMENT & POLICY                                        │',
    '├─────────────────────────────────────────────────────────────┤',
    `│ Environment:        ${padRight(data.environment.toUpperCase(), 38)}│`,
    `│ Policy:             ${padRight(data.policyName, 38)}│`,
    '└─────────────────────────────────────────────────────────────┘',
    '',
    '┌─────────────────────────────────────────────────────────────┐',
    '│ COMPLIANCE STATUS                                           │',
    '├─────────────────────────────────────────────────────────────┤',
    `│ Integration Health: ${padRight(formatStatus(data.integrationHealth), 38)}│`,
    `│ Version Drift:      ${padRight(data.driftStatus, 38)}│`,
    `│ Auditor:            ${padRight(formatStatus(data.auditorStatus), 38)}│`,
    `│ Strategist:         ${padRight(formatStatus(data.strategistStatus), 38)}│`,
    '└─────────────────────────────────────────────────────────────┘',
    '',
    '┌─────────────────────────────────────────────────────────────┐',
    '│ STATISTICS                                                  │',
    '├─────────────────────────────────────────────────────────────┤',
    `│ Integrations:       ${padRight(String(data.integrationCount), 38)}│`,
    `│ Ledger Entries:     ${padRight(String(data.ledgerEntryCount), 38)}│`,
    `│ Policy Violations:  ${padRight(String(data.policyViolations), 38)}│`,
    `│ Env Violations:     ${padRight(String(data.environmentViolations), 38)}│`,
    '└─────────────────────────────────────────────────────────────┘',
    '',
  ]
  
  // Add compliance verdict
  const isCompliant = 
    data.integrationHealth !== 'ERRORS' &&
    data.driftStatus === 'NONE' &&
    data.auditorStatus !== 'FAILED' &&
    data.policyViolations === 0 &&
    data.environmentViolations === 0
  
  if (isCompliant) {
    lines.push(
      '┌─────────────────────────────────────────────────────────────┐',
      '│                      ✓ COMPLIANT                            │',
      '│         This export meets all governance requirements.       │',
      '└─────────────────────────────────────────────────────────────┘'
    )
  } else {
    lines.push(
      '┌─────────────────────────────────────────────────────────────┐',
      '│                    ⚠ NON-COMPLIANT                          │',
      '│       This export has unresolved compliance issues.         │',
      '└─────────────────────────────────────────────────────────────┘'
    )
  }
  
  lines.push(
    '',
    '═══════════════════════════════════════════════════════════════',
    `Generated by TORBIT on ${new Date().toISOString()}`,
    '═══════════════════════════════════════════════════════════════'
  )
  
  return lines.join('\n')
}

// ============================================
// QUICK ATTESTATION
// ============================================

/**
 * Generate a quick attestation from current state
 */
export function generateQuickAttestation(
  environment: EnvironmentName,
  policyName: string,
  stats: {
    integrationCount: number
    ledgerEntryCount: number
    hasDrift: boolean
    hasHealthIssues: boolean
    auditorPassed: boolean
    strategistPassed: boolean
    policyViolations: number
    environmentViolations: number
  }
): AttestationFile {
  const data: AttestationData = {
    exportDate: new Date().toISOString(),
    environment,
    policyName,
    integrationHealth: stats.hasHealthIssues ? 'ERRORS' : 'CLEAN',
    driftStatus: stats.hasDrift ? 'DETECTED' : 'NONE',
    auditorStatus: stats.auditorPassed ? 'PASSED' : 'SKIPPED',
    strategistStatus: stats.strategistPassed ? 'PASSED' : 'SKIPPED',
    integrationCount: stats.integrationCount,
    ledgerEntryCount: stats.ledgerEntryCount,
    policyViolations: stats.policyViolations,
    environmentViolations: stats.environmentViolations,
  }
  
  return generateAttestation(data)
}

// ============================================
// UTILITIES
// ============================================

function formatDate(isoDate: string): string {
  const date = new Date(isoDate)
  return date.toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    timeZoneName: 'short',
  })
}

function formatStatus(status: string): string {
  const icons: Record<string, string> = {
    CLEAN: '✓ CLEAN',
    WARNINGS: '⚠ WARNINGS',
    ERRORS: '✗ ERRORS',
    PASSED: '✓ PASSED',
    FAILED: '✗ FAILED',
    SKIPPED: '○ SKIPPED',
    NONE: '✓ NONE',
    DETECTED: '⚠ DETECTED',
  }
  return icons[status] || status
}

function padRight(str: string, length: number): string {
  return str.padEnd(length)
}

/**
 * Generate a simple hash (for display purposes)
 * In production, use crypto.subtle.digest
 */
function generateHash(input: string): string {
  return `sha256:${createHash('sha256').update(input).digest('hex')}`
}

function signHash(hash: string, signingSecret: string, keyId: string) {
  return {
    algorithm: 'HMAC-SHA256' as const,
    keyId,
    value: createHmac('sha256', signingSecret).update(hash).digest('hex'),
    signedAt: new Date().toISOString(),
  }
}

/**
 * Serialize attestation to text file
 */
export function serializeAttestation(attestation: AttestationFile): string {
  const signatureBlock = attestation.signature
    ? [
        '',
        '───────────────────────────────────────────────────────────────',
        'ATTESTATION SIGNATURE',
        '───────────────────────────────────────────────────────────────',
        `Algorithm: ${attestation.signature.algorithm}`,
        `Key ID: ${attestation.signature.keyId}`,
        `Signed At: ${attestation.signature.signedAt}`,
        `Signature: ${attestation.signature.value}`,
      ]
    : []

  return [
    attestation.statement,
    '',
    '───────────────────────────────────────────────────────────────',
    'ATTESTATION HASH',
    '───────────────────────────────────────────────────────────────',
    attestation.hash,
    '',
    'This hash can be used to verify the integrity of this attestation.',
    ...signatureBlock,
    '───────────────────────────────────────────────────────────────',
  ].join('\n')
}
